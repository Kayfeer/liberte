services:
  liberte-relay:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: liberte-relay
    restart: unless-stopped
    ports:
      - "4001:4001/udp"   # libp2p QUIC
      - "8080:8080"       # HTTP API
    volumes:
      - liberte-data:/data
    environment:
      - RUST_LOG=${RUST_LOG:-liberte=info,libp2p=warn}
      - LISTEN_ADDR=/ip4/0.0.0.0/udp/4001/quic-v1
      - HTTP_ADDR=0.0.0.0:8080
      - BLOB_STORAGE_PATH=/data/blobs
      - PAYMENT_SERVER_PUBKEY=${PAYMENT_SERVER_PUBKEY:-0000000000000000000000000000000000000000000000000000000000000000}
      # Self-hosted settings
      - INSTANCE_NAME=${INSTANCE_NAME:-Libert√© Node}
      - PREMIUM_REQUIRED=${PREMIUM_REQUIRED:-false}
      - ADMIN_TOKEN=${ADMIN_TOKEN:-}
      - REGISTRATION_OPEN=${REGISTRATION_OPEN:-true}
      - MAX_PEERS=${MAX_PEERS:-0}
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"

volumes:
  liberte-data:
    driver: local
